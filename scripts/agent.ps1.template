# Softland Updater Agent
# Este script se ejecuta en cada PC cliente y se comunica con el servidor central.

# --- Configuración ---
$pcId = "__PC_ID__"
$serverUrl = "__SERVER_URL__"
$checkTaskUrl = "$serverUrl/api/tasks/check/$pcId"
$logUrl = "$serverUrl/api/tasks/log"
$agentDir = $PSScriptRoot
$localVersionFile = Join-Path $agentDir "version.txt"

# --- Funciones ---

# Función para enviar logs al servidor
function Send-Log {
    param(
        [string]$Action,
        [string]$Status,
        [string]$Message,
        [string]$VersionId
    )
    
    $pcName = $env:COMPUTERNAME
    $body = @{
        pcId = $pcId
        pcName = $pcName
        action = $Action
        status = $Status
        message = $Message
        versionId = $VersionId
    } | ConvertTo-Json

    try {
        Invoke-RestMethod -Uri $logUrl -Method Post -Body $body -ContentType 'application/json' -ErrorAction Stop
    } catch {
        Write-Warning "No se pudo enviar el log al servidor: $($_.Exception.Message)"
    }
}

# --- Bucle Principal ---
while ($true) {
    try {
        # 1. Verificar si hay tareas pendientes
        Write-Host "Verificando tareas en $checkTaskUrl"
        $response = Invoke-RestMethod -Uri $checkTaskUrl -Method Get -ErrorAction Stop
        
        if ($response.task -eq 'actualizar') {
            Send-Log -Action "Inicio de actualización" -Status "Éxito" -Message "Tarea de actualización recibida (ID: $($response.taskId))."
            
            # --- Aquí comienza la lógica de la actualización ---

            # Obtener configuración del servidor (simulado por ahora, se leería de un config.json o similar)
            $config = @{
                updateFilePath = "\\\\servidor\\actualizaciones\\softland_update_latest.7z"
                versionFilePath = "\\\\servidor\\actualizaciones\\version.txt"
                localUpdateDir = "C:\\ActualizacionSoftland"
                softlandInstallDir = "C:\\Softland"
                serviceName = "Softland POS Sincronización"
            }

            # 2. Comprobar la versión del software
            $serverVersion = ""
            $localVersion = ""

            try {
                if (Test-Path $config.versionFilePath) {
                    $serverVersion = Get-Content $config.versionFilePath -Raw
                } else {
                    Send-Log -Action "Comprobación de versión" -Status "Fallo" -Message "No se encontró el archivo de versión en el servidor: $($config.versionFilePath)"
                    # Continuar sin comprobación de versión si no se encuentra
                }
                
                if (Test-Path $localVersionFile) {
                    $localVersion = Get-Content $localVersionFile -Raw
                }
            } catch {
                 Send-Log -Action "Comprobación de versión" -Status "Fallo" -Message "Error al leer archivos de versión: $($_.Exception.Message)"
            }

            if ($serverVersion -ne "" -and $serverVersion -eq $localVersion) {
                Send-Log -Action "Comprobación de versión" -Status "Omitido" -Message "La PC ya tiene la última versión ($localVersion)." -VersionId $localVersion
                Start-Sleep -Seconds 60
                continue
            }

            Send-Log -Action "Comprobación de versión" -Status "Éxito" -Message "Se procederá a actualizar de la versión '$localVersion' a la '$serverVersion'."

            # (Los pasos de actualización continúan aquí...)
            # ...
            # ... simulación de pasos ...
            Start-Sleep -Seconds 5
            Send-Log -Action "Deteniendo servicio" -Status "Éxito" -Message "Servicio '$($config.serviceName)' detenido."
            
            Start-Sleep -Seconds 5
            Send-Log -Action "Copiando archivos" -Status "Éxito" -Message "Archivos copiados desde $($config.updateFilePath)."

            Start-Sleep -Seconds 10
            Send-Log -Action "Extrayendo archivos" -Status "Éxito" -Message "Archivos extraídos en $($config.softlandInstallDir)."
            
            # Al finalizar con éxito
            Send-Log -Action "Actualización completada" -Status "Éxito" -Message "El sistema se ha actualizado a la versión $serverVersion." -VersionId $serverVersion
            
            # Guardar la nueva versión localmente
            try {
                Set-Content -Path $localVersionFile -Value $serverVersion
            } catch {
                Send-Log -Action "Guardar versión local" -Status "Fallo" -Message "No se pudo escribir el nuevo archivo de versión en $localVersionFile."
            }

        } else {
            Write-Host "No hay tareas pendientes."
        }
    } catch {
        # Error al conectar con el servidor
        Write-Warning "No se pudo conectar con el servidor: $($_.Exception.Message)"
    }
    
    # Esperar 60 segundos antes de la próxima verificación
    Start-Sleep -Seconds 60
}
